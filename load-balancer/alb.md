# ALB

## ALBにSGが必要な理由

ALB（Application Load Balancer）にセキュリティグループ（SG）を設定する理由は、**ALB自体がトラフィックの「受け口」であり、インターネットからの通信をフィルタリングする必要がある**からです。

### ALBにSGが必要な理由（4点）

#### 1. **インターネットからの入口として ALB が外部に晒されるため**

* ALB は EC2 や Fargate などの内部リソースの前面に立つ **公開エンドポイント**。
* そのため、**HTTP/HTTPS/その他のリスナーポートを開放する必要がある**。
* セキュリティグループで \*\*「どのポートを、どこから許可するか」\*\*を制御する。

例：

```hcl
cidr_blocks = ["0.0.0.0/0"]  # 全世界に80, 443番を開放（Webサイト公開用）
```

#### 2. **ALBに直接アタッチされるセキュリティグループが、L4レベルの最初の防衛線**

* 通信は次のように進む：

  ```
  クライアント → ALB (SGによる受信制御) → ターゲット（EC2など）
  ```
* つまり、**ALBが「防波堤」として機能**する。

#### 3. **ALBのリスナーポートに対応する通信以外を拒否できる**

* 例：ALBのリスナーが80, 443のみのとき、SGで8080や22などをブロックしておくことで誤設定や脆弱性のリスクを最小限にできる。

#### 4. **ALBからターゲットグループへの通信も SG で制御可能**

* ALB → EC2 間の通信は、**ターゲット側（EC2など）のSGで ALBのSGを許可対象として設定**する必要がある。

例：

```hcl
security_group_rule {
  type        = "ingress"
  from_port   = 8080
  to_port     = 8080
  source_sg   = aws_security_group.alb.id
}
```

### SGがない場合のリスク

| リスク               | 説明                                      |
| ----------------- | --------------------------------------- |
| 不要なポートが開放される      | 誤ってALBに不要なリスナーやルールが残っていた場合、攻撃の対象にされる可能性 |
| トラフィック制御ができない     | 制限のない ALB は WAF やACLがない限り全通信を受けてしまう     |
| 内部向け ALB でも制限できない | 内部 ALB の場合も VPC 内からの攻撃や誤接続に備える必要がある     |

### まとめ

| SG設定対象             | 理由                                   |
| ------------------ | ------------------------------------ |
| ALB                | 外部からの入口をフィルタリングするため（HTTP/HTTPSなどを制限） |
| ターゲット（EC2/Fargate） | ALBからの正規な通信だけを許可するため（source SG指定）    |
